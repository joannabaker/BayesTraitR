---
title: "Readme"
output: github_document
date: "2023-04-26"
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
library(BayesTraitR)
```

# BayesTraitR

<!-- badges: start -->
<!-- badges: end -->

The goal of BayesTraitR is to facilitate phylogenetic comparative analyses in BayesTraits for R users. It comprises a suite of functions and tools that will be useful for wrangling datasets and trees into the appropriate format for analyses within BayesTraits as well as for interpreting and post-processing the outcomes of such analyses.

**Jump to:**

1) [Installation]

2) [Creating jobs to run in BayesTraits](#jobcreation)

3) [Multi-State Model Example](#multistate)

4) [Variable-Rates Model Example](#vr)

5) [Files bundled with BayesTraits](#BTFiles)



## Installation

You can install the development version of BayesTraitR from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("joannabaker/BayesTraitR")
```

You can download the latest version of [BayesTraits](http://www.evolution.reading.ac.uk/BayesTraitsV4.0.1/BayesTraitsV4.0.1.html) from the University of Reading website. Note that this package has been developed with the output from BayesTraitsV4.0.1 and different versions of the program may produce incompatible outputs.



## Creating Analyses {#jobcreation}

The function \code{createBTjob} is used to generate an input file, data file and tree file for use in downstream BayesTraits analyses. This can then be run interactively from within R (using \code{shell} or similar) or externally using the command-line interface. 

For all models that can be run in BayesTraits, we can simply specify a list of columns found in our dataset that we wish to include using the \code{cols} argument. However, for regression analyses that may include complex contrast coding, categorical variables, interactions and transformations (e.g. polynomials), users may wish to alternatively specify their analysis variables using the \code{fm} argument.  

### A worked example of creating and post-processing a multi-state model {#multistate}

We can create a multi-state model using the example files that are bundled with the BayesTraits download. These example files are also included as a part of this package. 

Please note that for this and all worked examples, the datasets are small and incomplete and should not be used for any scientific interpretation. They are included as illustrative examples of how to interact with BayesTraits and BayesTraitR only.


This is what the consensus artiodactyl tree looks like:
```{r,echo=F,include=T}
plot(consensus(Artiodactyl_trees))
```

And here is the data
```{r,echo=T,include=T}
class(Artiodactyl)
head(Artiodactyl)
```

To **create a maximum-likelihood multi-state model** across the Artiodactyl dataset and tree sample, we can use the following commands: 

``` r
createBTjob(cols = "multistate", model = 1, dataset = Artiodactyl, tree = Artiodactyl_trees, jobname = "MultiStateML", MCMC = F)
```

Note that we specify the following arguments:

* **jobname = "MultiStateML"**: This sets an identifier string with which all output files will be tagged.

* **cols = "multistate"**: This specifies the column we wish to run the model over in the input dataset. 

* **model = 1**: This specifies the multi-state model.

* **MCMC = F**: By selecting to not use MCMC, the model will revert to maximum-likelihood.

All other parameters are set to the default values. 

Running the above command will create a series of files in your current working directory:

* MultiStateML-001.txt

* MultiStateML.trees

* MultiStateML.infile


These files can then be used to run BayesTraits, either separately through your command-line interface or using shell (or similar) options direction from within R. 

For example:

``` r
shell("BayesTraitsV4.exe MultiStateML.trees MultiStateML-001.txt < MultiStateML.infile")
```

Running BayesTraits with these files will create a log file in your current working directory:

* MultiStateML-001.txt.Log.txt

Now, we can read in the log file into our R workspace using the \code{readBTlog} from this package. 

``` {r, include=T}
log = readBTlog("inst/extdata/MultiStateML-001.txt.Log.txt")
```

We can view this like we would any other R data.frame. Let's look at what the output looks like.
```{r,echo=T,include=T}
head(log)
```

**Coming soon...**
Plot the transition rates


## A worked example of creating and post-processing a variable rates model {#vr}
There is a specific set of commands and functions associated with the [variable rates model]{} and the [variable rates regression model]{}. We can use these functions to import the files output by variable rates analyses into R and post-process into results ready for interpretation. 

There are three types of variable rates models that can be run that each have very slight differences in the output files. 

Here, I will include how to run the variable rates post-processor using all three examples:

1) A variable rates model

2) A variable rates model across a sample of trees

3) A variable rates model across a tree sample, forcing equal tree sampling. 

### Let's start with (1).

We can create a single-trait variable rates model over a single tree using the example files that are bundled with the BayesTraits download. These example files are also included as a part of this package. 

Please note that for this and all worked examples, the datasets are small and incomplete and should not be used for any scientific interpretation. They are included as illustrative examples of how to interact with BayesTraits and BayesTraitR only.

This is what the consensus mammal tree looks like:
```{r,echo=F,include=T}
plot(consensus(Mammal_trees))
```

And here is the data
```{r,echo=T,include=T}
class(MammalBody)
head(MammalBody)
```

To **create a single-trait variable rates model** across the Mammal dataset and tree sample, we can use the following commands: 

``` r
createBTjob(cols = "Body", model = 7, dataset = MammalBody, tree = Mammal_trees, jobname = "MammalBody_VR", MCMC = T, optarg = c("varrates", "stones 500 10000"))
```
Note that we specify the following arguments, along with the dataset and tree objects:

* **jobname = "MammalBody_VR"**: This sets an identifier string with which all output files will be tagged.

* **cols = "Body"**: This specifies the column we wish to run the model over in the input dataset. 

* **model = 7**: This specifies the independent-contrast model for a single trait. Note that this does not output contrasts but instead uses the fast likelihood calculation in order to estimate complex model parameterization such as the variable rates models.

* **MCMC = T**: The variable rates model is only available for MCMC analyses. 

We also specify the following optional arguments using the **optarg = c(...)** argument:

* **varrates** Specifies the model should estimate variable rates.

* **stones 500 10000** Specifies that the model should be run with stepping-stone sampling. The model will run 500 stones for 10,000 iterations per stone. 

All other parameters are set to the default values. 

This will create a series of files in your current working directory:

* MammalBody_VR-001.txt

* MammalBody_VR.trees

* MammalBody_VR.infile


These files can then be used to run BayesTraits, either separately through your command-line interface or using shell (or similar) options direction from within R. 

``` r
shell("BayesTraitsV4.exe MammalBody.trees MammalBody-001.txt < MammalBody.infile")
```

This will create a number of output files in your current working directory:

* MammalBody-001.txt.Log.txt

* MammalBody-001.txt.Output.trees

* MammalBody-001.txt.Schedule.txt

* MammalBody-001.txt.Stones.txt

* MammalBody-001.txt.VarRates.txt

Now, we can read in the log file into our R workspace using \code{readBTlog}. 

``` {r, include=T}
log = readBTlog("inst/extdata/MultiStateML-001.txt.Log.txt")
```

We can view this like we would any other R data.frame. Let's look at what the output looks like.
```{r,echo=T,include=T}
head(log)
```

Let's summarize the variable rates output, and create a stretched tree :
```{r, echo = T, include=T}
res = summarizeVR(vrfile = "inst/extdata/MammalBody_VR-001.txt.VarRates.txt", treefile = "inst/extdata/Mammal_Consensus.trees")

stretchedtree = read.nexus("inst/extdata/Mammal_Consensus.trees")
stretchedtree$edge.length = stretchedtree$edge.length * res$ratesummary$medianscalar[-1]

plot(stretchedtree)

```

**NOTE**: because we input a sample of trees, we must specify only a single tree to summarize on. Here we calculate and use a consensus tree but this can be any tree of your choice - as long as it contains the same taxa that were included in the analysis. 

Any branches that were stretched that do not exist in your single summarizing tree will be assigned to their most recent common ancestor.


## BayesTraits Files{#BTFiles}

This package contains the sample files bundled with BayesTraits. 
This includes the following trees:

* Artiodactyl_trees (A sample of 500 trees of 17 artiodactyls.)

* Bird_tree (A tree of 5669 birds.)

* Mammal_trees (A sample of 50 trees of 40 mammals.)

* Marsupials_tree (A tree of 246 marsupials.)

* NortheastBantu_tree (A tree of 85 Bantu languages.)

* Primates_trees (A sample of 500 trees of 60 primate species.)


And the following data files:

* Artiodactyl (for multi-state analysis)

* BirdTerritory (for heterogeneous models)

* MammalBody (for continuous models)

* MammalBrainBody (for correlational or regression models)

* MammalBrainBodyGt (for multicorrelational or multivariate regression models)

* MammalBrainBodySampleData (an example of how to include multiple values per species)

* Marsupials (for continuous models, specifically variable rates)

* MammalModelB (a dataset to depict trend or model B runs - not real data)

* NortheastBantu (for geo models)

* Primates (for discrete models)
